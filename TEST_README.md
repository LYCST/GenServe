# GenServe 并发测试指南

本目录包含了用于测试GenServe并发排队机制的测试脚本。

## 测试脚本说明

### 1. `test_simple.py` - 简化并发测试
**用途**: 快速验证基本的并发排队机制
**特点**: 
- 只测试text2img模式
- 使用较小的图片尺寸(512x512)和较少的推理步数(10步)
- 快速获得结果，适合日常测试

### 2. `test_concurrent.py` - 完整并发测试
**用途**: 全面测试所有功能的并发性能
**特点**:
- 测试所有模式(text2img, fill, controlnet)
- 使用真实的图片数据
- 详细的性能分析和负载均衡评估
- 生成详细的测试报告

## 使用方法

### 前置条件
1. 确保GenServe服务正在运行
2. 安装测试依赖：
```bash
pip install aiohttp
```

### 运行简化测试
```bash
python3 test_simple.py
```

### 运行完整测试
```bash
python3 test_concurrent.py
```

### 自定义测试参数
编辑脚本中的配置参数：
```python
# test_simple.py
BASE_URL = "http://localhost:12411"  # 服务地址
TOTAL_REQUESTS = 20                  # 总请求数
CONCURRENT_LIMIT = 5                 # 并发限制

# test_concurrent.py
TOTAL_REQUESTS = 30                  # 总请求数
CONCURRENT_LIMIT = 8                 # 并发限制
```

## 测试结果解读

### 成功指标
1. **成功率**: 应该接近100%
2. **响应时间**: 平均响应时间应该合理
3. **负载均衡**: 多个GPU应该被均匀使用
4. **队列管理**: 请求应该被正确排队和处理

### 关键指标说明
- **负载均衡评估**: 1.0为完美均衡，<0.5表示负载不均衡
- **平均响应时间**: 包含排队等待时间
- **GPU使用情况**: 显示每个GPU处理的请求数量

### 预期结果
```
📊 测试结果分析
==================================================
总请求数: 20
成功请求: 20 (100.0%)
失败请求: 0 (0.0%)
总耗时: 45.23s
平均响应时间: 2.26s
最大响应时间: 3.45s
最小响应时间: 1.12s

🎮 GPU使用情况:
  GPU 0: 10 个请求
  GPU 1: 10 个请求

⚖️ 负载均衡评估: 1.00 (1.0为完美均衡)
✅ 负载均衡效果良好
==================================================
```

## 故障排除

### 常见问题

1. **连接失败**
   - 检查服务是否正在运行
   - 确认端口号是否正确
   - 检查防火墙设置

2. **请求超时**
   - 减少并发数量
   - 增加推理步数
   - 检查GPU资源使用情况

3. **负载不均衡**
   - 检查GPU进程是否正常启动
   - 查看服务日志确认进程状态
   - 调整调度器配置

### 调试建议

1. **查看服务日志**
```bash
# 在服务启动时查看详细日志
./start.sh
```

2. **监控GPU使用情况**
```bash
# 实时监控GPU使用
watch -n 1 nvidia-smi
```

3. **检查服务状态**
```bash
# 检查服务健康状态
curl http://localhost:12411/health
```

## 性能优化建议

### 并发数量设置
- **建议**: 并发数量不超过GPU数量
- **测试**: 从GPU数量的一半开始，逐步增加
- **监控**: 观察GPU内存使用率和响应时间

### 请求参数优化
- **推理步数**: 测试时使用较少步数(10-20)
- **图片尺寸**: 测试时使用较小尺寸(512x512)
- **优先级**: 测试不同优先级的效果

### 系统资源监控
- **GPU内存**: 确保有足够的内存处理并发请求
- **CPU使用率**: 监控调度器的CPU使用情况
- **网络带宽**: 确保网络能处理并发连接

## 测试报告

测试完成后，完整测试会生成详细的JSON报告文件：
```
concurrent_test_results_1234567890.json
```

报告包含：
- 测试摘要统计
- GPU和模型使用情况
- 详细的请求结果
- 性能指标分析

## 扩展测试

### 压力测试
增加请求数量和并发数，测试系统极限：
```python
TOTAL_REQUESTS = 100
CONCURRENT_LIMIT = 20
```

### 长时间测试
运行长时间测试，检查内存泄漏和稳定性：
```python
# 循环运行测试
for i in range(10):
    await run_concurrent_test()
    time.sleep(60)  # 等待1分钟
```

### 混合负载测试
同时测试不同类型的请求，模拟真实使用场景。 